<script>
  import * as Card from "$lib/components/ui/card";
  import SimplePlayer from "./SimplePlayer.svelte";
  import { CircleCheck, Ban } from "lucide-svelte";
  import { get, writable } from "svelte/store";
  import { web3 } from "svelte-web3";
  import * as Tooltip from "$lib/components/ui/tooltip";
  export let id = null;
  export let name = null;
  export let price = null;
  export let img = null;
  export let videos = null;
  export let redirect = null;
  export let variant = "default";
  export let selected = false;
  export let selling = false;
  export let css =
    "flex flex-col items-center bg-gray-800 p-4 hover:bg-gray-700 transition rounded-lg shadow-lg overflow-hidden";
  let s_id = id.toString();
  let isHovered = false;

  // Counter for selected cards
  export let toggleSelect = () => {};
  export let selectedCount = writable(0);
  function handleToggleSelect() {
    if (selling) return;
    const count = get(selectedCount);
    if (count !== toggleSelect(id, !selected)) {
      selected = !selected;
    }
  }
</script>

{#if variant === "default" || variant === "animated"}
  <a
    href="/{redirect}/{id}"
    class="w-full"
    on:mouseover={() => {
      isHovered = true;
    }}
    on:focus={() => {
      isHovered = true;
    }}
    on:mouseout={() => {
      isHovered = false;
    }}
    on:blur={() => {
      isHovered = false;
    }}
  >
    <Card.Root class={css}>
      <div class="flex-shrink-0 w-full relative">
        {#if !isHovered || variant === "default"}
          <img
            class="aspect-square w-full object-cover hover:scale-105 transition-transform duration-200 ease-in-out"
            src={img}
            alt={name}
          />
        {:else}
          <SimplePlayer
            {videos}
            css={"aspect-square w-full"}
            controls={false}
          />
        {/if}
      </div>
      <div class="mt-4 w-full text-center text-white">
        <div class="text-lg font-bold">{name}</div>
        <div
          class="whitespace-nowrap uppercase tracking-wide text-sm overflow-hidden text-gray-400 font-semibold text-ellipsis text-wrap"
        >
          #{s_id}
        </div>
        {#if selling}
          <p class="mt-2 text-gray-400">
            {$web3.utils.fromWei(price, "ether")} ETH
          </p>
        {:else}
          <p class="mt-2 text-gray-400">Not for sale</p>
        {/if}
      </div>
    </Card.Root>
  </a>
{:else if variant === "select"}
  <!-- svelte-ignore a11y-invalid-attribute -->
  <Tooltip.Root openDelay={300}>
    <Tooltip.Trigger>
      <button
        class="w-full relative"
        tabindex="-1"
        on:mouseover={() => {
          isHovered = true;
        }}
        on:focus={() => {
          isHovered = true;
        }}
        on:mouseout={() => {
          isHovered = false;
        }}
        on:blur={() => {
          isHovered = false;
        }}
        on:click={handleToggleSelect}
      >
        <Card.Root class={css}>
          {#if selling}
            <div
              class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
            >
              <Ban class="w-16 h-16 text-red-500" />
            </div>
          {/if}
          {#if selected}
            <div
              class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
            >
              <CircleCheck class="w-16 h-16 text-green-500" />
            </div>
          {/if}
          <div class="flex-shrink-0 w-full relative">
            {#if !isHovered}
              <img
                class="aspect-square w-full object-cover hover:scale-105 transition-transform duration-200 ease-in-out"
                src={img}
                alt={name}
              />
            {:else}
              <SimplePlayer
                {videos}
                css={"aspect-square w-full"}
                controls={false}
              />
            {/if}
          </div>
          <div class="mt-4 w-full text-center text-white">
            <div class="text-lg font-bold">{name}</div>
            <div
              class="uppercase tracking-wide text-sm text-gray-400 font-semibold text-wrap overflow-hidden text-ellipsis"
            >
              #{s_id}
            </div>
          </div>
        </Card.Root>
      </button>
    </Tooltip.Trigger>

    {#if selling}
      <Tooltip.Content>
        <p>The NFT is selling</p>
      </Tooltip.Content>
    {/if}
  </Tooltip.Root>
{/if}
